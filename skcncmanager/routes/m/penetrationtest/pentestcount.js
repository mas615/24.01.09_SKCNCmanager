var express = require('express');
var router = express.Router();
var db = require('../../db');

router.get('/', function(req, res, next) {
    sql = `select 'A1',count(*) from penetrationtest where manage_code LIKE 'A%' and testcount=0 union select 'A2',sum(urlcount) from penetrationtest where manage_code LIKE 'A%' and testcount=0 union select 'A3',count(*) from penetrationtest_vulner where manage_code LIKE 'A%' and testcount=0`;
    sqlfor = ['A','B','C','D','E'];
    for(const sqlforkey of sqlfor){
        console.log(sqlforkey);
        sql += ` union select '${sqlforkey}1',count(*) from penetrationtest where manage_code LIKE '${sqlforkey}%' and testcount=0 union select '${sqlforkey}2',sum(urlcount) from penetrationtest where manage_code LIKE '${sqlforkey}%' and testcount=0 union select '${sqlforkey}3',count(*) from penetrationtest_vulner where manage_code LIKE '${sqlforkey}%' and testcount=0`;
    };
    db.query(sql, (error, rows, fields) => {
        console.log(rows);
        var title = "타이틀"
        var head = "헤드"
        var body = "<table border='1'><tr><th>구분</th><th>서비스수</th><th>URL수</th><th>취약점수</th></tr>";
        var tdcount = 0;
        var allservicecount = 0;
        var allurlcount = 0;
        var allvulnercount = 0;
        for (const sqlforkey of sqlfor){
            console.log(sqlforkey);
            body += `<tr><th>${sqlforkey}</th>`;
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            allservicecount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            allurlcount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            allvulnercount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            body += `</tr>`;
        };
        body +=`<tr><th>합계</th><th>${allservicecount}</th><th>${allurlcount}</th><th>${allvulnercount}</th></tr></table>`;
        res.render('tmp', { title : title, head : head, body : body});
    });
    
});

module.exports = router;
