var express = require('express');
var router = express.Router();
var db = require('../../db');

router.get('/', function(req, res, next) {
    sql = `select 'A1',count(*) from penetrationtest where manage_code LIKE 'A%' and testcount=0 union select 'A2',sum(urlcount) from penetrationtest where manage_code LIKE 'A%' and testcount=0 union select 'A3',count(*) from penetrationtest_vulner where manage_code LIKE 'A%' and testcount=0`;
    sqlfor = ['A','B','C','D','E'];
    for(const sqlforkey of sqlfor){
        console.log(sqlforkey);
        sql += ` union select '${sqlforkey}1',count(*) from penetrationtest where manage_code LIKE '${sqlforkey}%' and testcount=0 union select '${sqlforkey}2',sum(urlcount) from penetrationtest where manage_code LIKE '${sqlforkey}%' and testcount=0 union select '${sqlforkey}3',count(*) from penetrationtest_vulner where manage_code LIKE '${sqlforkey}%' and testcount=0`;
    };
    db.query(sql, (error, rows, fields) => {
        console.log(rows);
        var title = "타이틀"
        var head = `<link href="/handsontable/handsontable.full.css" rel="stylesheet">`;
        var body = "<table border='1'><tr><th>구분</th><th>서비스수</th><th>URL수</th><th>취약점수</th></tr>";
        var tdcount = 0;
        var allservicecount = 0;
        var allurlcount = 0;
        var allvulnercount = 0;
        const data =[];        
        for (const sqlforkey of sqlfor){
            const datadata = [];
            console.log(sqlforkey);
            body += `<tr><th>${sqlforkey}</th>`;
            datadata.push(sqlforkey);
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            datadata.push(rows[tdcount]['count(*)']);
            allservicecount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            datadata.push(rows[tdcount]['count(*)']);
            allurlcount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            body += `<td>${rows[tdcount]['count(*)']}</td>`;
            datadata.push(rows[tdcount]['count(*)']);
            allvulnercount += parseInt(rows[tdcount]['count(*)']);
            tdcount ++;
            data.push(datadata);
            body += `</tr>`;
        };
        body += `<tr><th>합계</th><th>${allservicecount}</th><th>${allurlcount}</th><th>${allvulnercount}</th></tr></table>`;
        body += `<br><div id="example"></div>`;
        script = `<script src="/handsontable/handsontable.full.js"></script>

        <script>
        // 서버에서 전달된 데이터를 EJS 템플릿에서 사용
        const data = ${JSON.stringify(data)};
    
        // Handsontable을 초기화하고 옵션을 설정합니다.
        const container = document.getElementById('example');
        const hot = new Handsontable(container, {
            data: data,
            colHeaders: [
                "구분",
                "서비스수",
                "URL수",
                "취약점수"
            ],
            rowHeaders: true,
            licenseKey: 'non-commercial-and-evaluation',
            afterPaste: (data, coords) => {
                const a = coords[0].startRow;
                const b = coords[0].endRow;
                const rowIndices = [];
                for (let i = a; i <= b; i++) {
                    // 반복하고자 하는 동작 수행
                    rowIndices.push(i);
                };
                const rowDataToSend = rowIndices.map(rowIndex => hot.getDataAtRow(rowIndex));
                console.log(rowDataToSend);

                sendRowDataToServer(rowDataToSend);
            },

            afterChange: (changes, source) => {
                if (source === 'edit') {
                    const rowIndices = changes.map(change => change[0]);
                    console.log(rowIndices);
                    const rowDataToSend = rowIndices.map(rowIndex => hot.getDataAtRow(rowIndex));
                    console.log(rowDataToSend);

                    sendRowDataToServer(rowDataToSend);
                }
            },
        });
    
        // Function to send row data to the server
        function sendRowDataToServer(rowData) {
            const sanitizedRowData = rowData.map(row => (row === undefined ? null : row));

            fetch('/m/penetrationtest/gridtest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rowData: sanitizedRowData }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('Error updating row data:', error);
            });
        }
    </script>
    `;
        res.render('tmpgrid', { title : title, head : head, body : body, script : script});
    });
    
});

module.exports = router;
