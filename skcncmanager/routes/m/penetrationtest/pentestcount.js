var express = require('express');
var router = express.Router();
var db = require('../../db');

router.get('/', function(req, res, next) {
    sql = `SELECT COUNT(*) FROM penetrationtest WHERE manage_code LIKE 'A%' AND testcount=0 
    UNION ALL
    SELECT SUM(urlcount) FROM penetrationtest p1 WHERE testcount = (SELECT MAX(testcount) FROM penetrationtest p2 WHERE p1.manage_code = p2.manage_code) AND manage_code LIKE 'A%'  
    UNION ALL
    SELECT COUNT(*) AS row_count FROM (
        SELECT t1.* FROM penetrationtest_vulner t1 
        LEFT JOIN penetrationtest_vulner t2 ON t1.manage_code = t2.manage_code AND t1.testcount < t2.testcount 
        WHERE t2.seq IS NULL AND t1.manage_code LIKE 'A%'
    ) AS subquery 
    UNION ALL
    SELECT COUNT(*) FROM penetrationtest WHERE manage_code LIKE 'B%' AND testcount=0 
    UNION ALL
    SELECT SUM(urlcount) FROM penetrationtest p1 WHERE testcount = (SELECT MAX(testcount) FROM penetrationtest p2 WHERE p1.manage_code = p2.manage_code) AND manage_code LIKE 'B%'  
    UNION ALL
    SELECT COUNT(*) AS row_count FROM (
        SELECT t1.* FROM penetrationtest_vulner t1 
        LEFT JOIN penetrationtest_vulner t2 ON t1.manage_code = t2.manage_code AND t1.testcount < t2.testcount 
        WHERE t2.seq IS NULL AND t1.manage_code LIKE 'B%'
    ) AS subquery 
    UNION ALL
    SELECT COUNT(*) FROM penetrationtest WHERE manage_code LIKE 'C%' AND testcount=0 
    UNION ALL
    SELECT SUM(urlcount) FROM penetrationtest p1 WHERE testcount = (SELECT MAX(testcount) FROM penetrationtest p2 WHERE p1.manage_code = p2.manage_code) AND manage_code LIKE 'C%'  
    UNION ALL
    SELECT COUNT(*) AS row_count FROM (
        SELECT t1.* FROM penetrationtest_vulner t1 
        LEFT JOIN penetrationtest_vulner t2 ON t1.manage_code = t2.manage_code AND t1.testcount < t2.testcount 
        WHERE t2.seq IS NULL AND t1.manage_code LIKE 'C%'
    ) AS subquery
    UNION ALL
    SELECT COUNT(*) FROM penetrationtest WHERE manage_code LIKE 'D%' AND testcount=0 
    UNION ALL
    SELECT SUM(urlcount) FROM penetrationtest p1 WHERE testcount = (SELECT MAX(testcount) FROM penetrationtest p2 WHERE p1.manage_code = p2.manage_code) AND manage_code LIKE 'D%'  
    UNION ALL
    SELECT COUNT(*) AS row_count FROM (
        SELECT t1.* FROM penetrationtest_vulner t1 
        LEFT JOIN penetrationtest_vulner t2 ON t1.manage_code = t2.manage_code AND t1.testcount < t2.testcount 
        WHERE t2.seq IS NULL AND t1.manage_code LIKE 'D%'
    ) AS subquery
    UNION ALL
    SELECT COUNT(*) FROM penetrationtest WHERE manage_code LIKE 'E%' AND testcount=0 
    UNION ALL
    SELECT SUM(urlcount) FROM penetrationtest p1 WHERE testcount = (SELECT MAX(testcount) FROM penetrationtest p2 WHERE p1.manage_code = p2.manage_code) AND manage_code LIKE 'E%'  
    UNION ALL
    SELECT COUNT(*) AS row_count FROM (
        SELECT t1.* FROM penetrationtest_vulner t1 
        LEFT JOIN penetrationtest_vulner t2 ON t1.manage_code = t2.manage_code AND t1.testcount < t2.testcount 
        WHERE t2.seq IS NULL AND t1.manage_code LIKE 'E%'
    ) AS subquery;
    `;
    const data = [['A.사내시스템'],['B.그룹공통'],['C.신규투자'],['D.사업부서요청'],['E.멤버사진단']];
    var forcount = 0;
    var datacount = 0;
    db.query(sql, (error, rows, fields) => {
        for(const key of rows){
            //console.log(key['COUNT(*)'])
            data[datacount].push(key['COUNT(*)'])
            if (forcount == 2){
                forcount = 0;
                datacount += 1;
            }else {
                forcount += 1;
            }
        };
        console.log(data)
        body = `<br><div id="example"></div>`;
        script = `<script src="/handsontable/handsontable.full.js"></script>
        <script>const data = ${JSON.stringify(data)};</script>
        <script src="/js/js_pentestcount.js"></script>`;
        res.render('tmpgrid', { title : "통계", head : "head", body : body, script : script});
    });
    
});

module.exports = router;
